#!/usr/bin/env node

/**
 * SOLUTION: Get Fresh reCAPTCHA Tokens
 * 
 * reCAPTCHA tokens expire after 2-5 minutes!
 * This script:
 * 1. Opens Google Flow
 * 2. Waits for you to interact with the page
 * 3. Captures FRESH reCAPTCHA tokens generated by the browser
 * 4. Saves them with current timestamp
 * 5. These fresh tokens can be used for the next 5 minutes
 */

import puppeteer from 'puppeteer-extra';
import StealthPlugin from 'puppeteer-extra-plugin-stealth';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __dirname = path.dirname(fileURLToPath(import.meta.url));
puppeteer.use(StealthPlugin());

async function getFreshTokens() {
  console.log('======================================================================');
  console.log('üÜï GET FRESH reCAPTCHA TOKENS (Valid for 5 minutes)');
  console.log('======================================================================\n');

  let browser;

  try {
    browser = await puppeteer.launch({
      headless: false,
      args: ['--no-sandbox', '--disable-dev-shm-usage']
    });

    const page = await browser.newPage();
    await page.setViewport({ width: 1280, height: 720 });

    // Load existing session for authentication
    const sessionPath = path.join(__dirname, '../.sessions/google-flow-session-complete.json');
    const sessionData = JSON.parse(fs.readFileSync(sessionPath, 'utf8'));

    // Set cookies for authentication
    for (const cookie of (sessionData.cookies || [])) {
      try {
        await page.setCookie(cookie);
      } catch (e) {
        // Ignore
      }
    }

    console.log('üìù INSTRUCTIONS:');
    console.log('   1. Browser will open to Google Flow');
    console.log('   2. Simply INTERACT with the page naturally:\n');
    console.log('      ‚Ä¢ Type the prompt into the textbox');
    console.log('      ‚Ä¢ Click Generate or press Enter\n');
    console.log('   3. AS SOON AS you click Generate:');
    console.log('      - Press Ctrl+C in this terminal');
    console.log('      - Script will capture the fresh token\n');

    console.log('‚úÖ Session cookies loaded\n');
    console.log('üåê Navigating to Google Flow...\n');

    await page.goto('https://labs.google/fx/vi/tools/flow/project/58d791d4-37c9-47a8-ae3b-816733bc3ec0', {
      waitUntil: 'networkidle2'
    });

    console.log('‚úÖ Page loaded\n');
    console.log('‚è≥ Entering test prompt and generating...\n');

    // Enter prompt using proper Slate editor method
    const testPrompt = 'A beautiful white flowing dress on a woman standing in natural light, professional fashion photography, 8K quality, studio lighting, full body';
    
    try {
      // Find and focus the Slate textbox
      const promptDiv = await page.$('[role="textbox"][data-slate-editor="true"]');
      if (!promptDiv) {
        throw new Error('Prompt textbox not found');
      }

      // Focus
      await page.evaluate(() => {
        const textbox = document.querySelector('[role="textbox"][data-slate-editor="true"]');
        if (textbox) textbox.focus();
      });
      await page.waitForTimeout(300);

      // Type prompt
      console.log('üìù Typing prompt...');
      await page.keyboard.type(testPrompt, { delay: 1 });
      await page.waitForTimeout(1000);

      // Dispatch events
      await page.evaluate(() => {
        const textbox = document.querySelector('[role="textbox"][data-slate-editor="true"]');
        if (textbox) {
          textbox.dispatchEvent(new Event('input', { bubbles: true }));
          textbox.dispatchEvent(new Event('change', { bubbles: true }));
        }
      });

      // Press Enter to submit
      console.log('‚úì Submitting prompt with Enter...');
      await page.keyboard.press('Enter');
      console.log('‚úì Submitted\n');

      // Wait for processing
      console.log('‚è≥ Waiting 5 seconds for processing...');
      await page.waitForTimeout(5000);

    } catch (error) {
      console.log(`‚ö†Ô∏è  Error entering prompt: ${error.message}`);
      console.log('Please manually enter and submit a prompt using the page.\n');
      console.log('‚è≥ Waiting for manual submission (5 minutes)...\n');
      await page.waitForTimeout(300000);
    }

    // Capture FRESH tokens at this moment
    console.log('\nüîç Capturing fresh tokens...\n');

    const tokenCapture = await page.evaluate(() => {
      return {
        _grecaptcha: window.localStorage.getItem('_grecaptcha'),
        'rc::a': window.localStorage.getItem('rc::a'),
        'rc::f': window.localStorage.getItem('rc::f'),
        timestamp: new Date().toISOString()
      };
    });

    console.log('üìä Fresh Tokens Captured:\n');
    const tokenCount = Object.values(tokenCapture)
      .filter(v => v && typeof v === 'string' && v.length > 0).length;

    if (tokenCapture._grecaptcha) {
      console.log(`   ‚úÖ _grecaptcha: ${tokenCapture._grecaptcha.substring(0, 40)}...`);
    } else {
      console.log(`   ‚ùå _grecaptcha: NOT FOUND`);
    }

    if (tokenCapture['rc::a']) {
      console.log(`   ‚úÖ rc::a: ${tokenCapture['rc::a'].substring(0, 40)}...`);
    } else {
      console.log(`   ‚ùå rc::a: NOT FOUND`);
    }

    if (tokenCapture['rc::f']) {
      console.log(`   ‚úÖ rc::f: ${tokenCapture['rc::f'].substring(0, 40)}...`);
    } else {
      console.log(`   ‚ùå rc::f: NOT FOUND`);
    }

    console.log(`   üìÖ Timestamp: ${tokenCapture.timestamp}`);
    console.log(`\n   Total tokens found: ${tokenCount}/3\n`);

    if (tokenCount === 0) {
      console.log('‚ö†Ô∏è  No reCAPTCHA tokens found!');
      console.log('\nüí° This might happen if:');
      console.log('   1. You havent interacted with the page yet');
      console.log('   2. reCAPTCHA hasnt been triggered');
      console.log('   3. Browser blocked reCAPTCHA from running\n');
    } else if (tokenCount < 3) {
      console.log('‚ö†Ô∏è  Only some tokens found - might be incomplete\n');
    } else {
      console.log('‚úÖ All 3 reCAPTCHA tokens captured successfully!\n');
    }

    // Update session file with fresh tokens
    console.log('üíæ Updating session file with fresh tokens...\n');

    // Load fresh from page, NOT from localStorage since we just touched page
    const freshTokensToSave = {
      _grecaptcha: tokenCapture._grecaptcha,
      'rc::a': tokenCapture['rc::a'],
      'rc::f': tokenCapture['rc::f']
    };

    // Update localStorage in session with fresh tokens
    sessionData.localStorage._grecaptcha = freshTokensToSave._grecaptcha;
    sessionData.localStorage['rc::a'] = freshTokensToSave['rc::a'];
    sessionData.localStorage['rc::f'] = freshTokensToSave['rc::f'];

    // Update timestamp
    sessionData.timestamp = tokenCapture.timestamp;
    sessionData.expiresAt = new Date(Date.now() + 5 * 60 * 1000).toISOString(); // 5 minute validity

    // Save updated session
    fs.writeFileSync(sessionPath, JSON.stringify(sessionData, null, 2));

    console.log(`‚úÖ Session file updated: ${sessionPath}`);
    console.log(`\nüìä Session Info:`);
    console.log(`   ‚Ä¢ Timestamp: ${sessionData.timestamp}`);
    console.log(`   ‚Ä¢ Expires At: ${sessionData.expiresAt}`);
    console.log(`   ‚Ä¢ Valid For: 5 minutes\n`);

    console.log('üöÄ NEXT STEPS:\n');
    console.log('   1. Run your automation: node scripts/test-google-flow-generation.js');
    console.log('   2. It will use these fresh tokens (valid for 5 minutes)');
    console.log('   3. If it works, integrate into main flow!\n');

    console.log('‚ö†Ô∏è  IMPORTANT: These tokens expire in 5 minutes!');
    console.log('   Run this script again if you need fresh tokens for a new test\n');

  } catch (error) {
    console.error('‚ùå Error:', error.message);
    console.log('\nüí° Make sure you have a valid session file at: .sessions/google-flow-session-complete.json');
  } finally {
    if (browser) {
      console.log('Closing browser...');
      await browser.close();
    }
  }
}

getFreshTokens().catch(console.error);
